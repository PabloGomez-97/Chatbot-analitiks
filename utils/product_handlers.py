from .message_formatter import format_product_info #
from utils.message_formatter import create_menu_message
from .db_helpers import save_message #
import json
import requests
from urllib.parse import quote
from bs4 import BeautifulSoup

def handle_product_search_options(user_number, incoming_message, response, user, user_state):
    name, company = user
    if incoming_message == '1':
        user_state[user_number] = 'product_info'
        """ Opci√≥n 1: Cambia el estado a 'product_info' y redirige a la l√≥gica en utils.product_handlers.py -> handle_specific_product_info. """
        response.message(
            "Por favor, ingresa el nombre exacto del producto que est√°s buscando"
        )
    elif incoming_message == '2':
        user_state[user_number] = 'assistant_mode'
        """ Opci√≥n 2: Cambia el estado a 'assistant_mode' y redirige a la l√≥gica en openai.chat_mode.py -> handle_assistant_mode. """
        response.message(
            "Describe el producto que necesitas y te ayudar√© a encontrarlo"
        )
    else:
        response.message(
            "‚ö†Ô∏è *Opci√≥n no v√°lida*\n\n"
            "Por favor selecciona:\n"
            "1Ô∏è‚É£ *Conozco el nombre del producto*\n"
            "2Ô∏è‚É£ *No conozco el nombre del producto*"
        )
    return str(response)


"""" Es utilizado en -> utils/product_handler.py """
def get_product_info(product_name):
    try:
        with open('productos.json', encoding="utf-8") as file:
            products = json.load(file)["products"]
        for product in products:
            if product_name.lower() == product["title"].lower():
                ficha_tecnica_msg = (f"üìë [Ficha t√©cnica]({product['ficha_tecnica']})" 
                                     if product['ficha_tecnica'] 
                                     else "üìë Ficha t√©cnica no disponible.")
                return (f"üîπ *{product['title']} {product['url']}*\n"
                        f"üìÇ Categor√≠as: {', '.join(product['categories'])}\n"
                        f"{ficha_tecnica_msg}\n"
                        f"üìÑ {product['description']}\n")
        return "Lo siento, no encontr√© un producto con ese nombre. Aseg√∫rate de escribir el nombre exacto."
    except FileNotFoundError:
        return "No se encontr√≥ el archivo de productos. Por favor, actual√≠zalo usando la ruta /update_products."


""" Es utilizado en -> utils/product_handlers.py opci√≥n 1"""
def handle_specific_product_info(user_number, incoming_message, response, user_state, name, company):
    if incoming_message.lower() == "salir":
        user_state.pop(user_number, None)
        response.message(create_menu_message(name, company))
        return str(response)
    
    product_info = get_product_info(incoming_message)
    save_message(user_number, product_info, 'Bot')
    response.message(format_product_info(product_info))
    return str(response)


def fetch_and_save_products_json():
    base_url = "https://analitiks.cl/categoria-producto/productos/page/{}/"
    page = 1
    products = []

    while True:
        response = requests.get(base_url.format(page))
        if response.status_code != 200:
            print(f"Final de las p√°ginas alcanzado o error en la p√°gina {page}. C√≥digo de estado: {response.status_code}")
            break

        soup = BeautifulSoup(response.content, "html.parser")
        product_elements = soup.select("ul.products li.product")

        if not product_elements:
            print(f"No se encontraron m√°s productos en la p√°gina {page}.")
            break

        for product in product_elements:
            product_url = product.select_one("a.woocommerce-LoopProduct-link")["href"]
            
            # Fetch the product detail page to extract description, categories, and ficha t√©cnica
            product_response = requests.get(product_url)
            if product_response.status_code != 200:
                print(f"Error al acceder a la p√°gina del producto: {product_url}. C√≥digo de estado: {product_response.status_code}")
                continue

            product_soup = BeautifulSoup(product_response.content, "html.parser")
            categories = [cat.text.strip() for cat in product_soup.select(".posted_in a")]
            description = product_soup.select_one(".woocommerce-Tabs-panel--description")
            description = description.text.strip() if description else "Descripci√≥n no disponible."

            # Extract the URL of the ficha t√©cnica
            ficha_tecnica = product_soup.find("a", string=lambda text: text and "Ficha T√©cnica" in text)
            ficha_tecnica_url = ficha_tecnica["href"] if ficha_tecnica else None

            # Encode the ficha_tecnica_url
            if ficha_tecnica_url:
                ficha_tecnica_url = quote(ficha_tecnica_url, safe=":/")

            # Add cotizacion field with a cleaner mailto link
            mailto_link = (
                f"mailto:cotizaciones@analitiks.cl?"
                f"subject=Cotizaci√≥n%20producto%20{quote(product.select_one('h2.woocommerce-loop-product__title').text.strip())}&"
                f"body=Hola,%me%interesar√≠a%obtener%una%cotizaci√≥n%de%este%producto.%Por%favor,%indicar%detalles%y%precio."
            )
            cotizacion_message = (
                f"Solicita una cotizaci√≥n aqu√≠: ,({mailto_link})."
            )

            product_data = {
                "title": product.select_one("h2.woocommerce-loop-product__title").text.strip(),
                "url": product_url,
                "categories": categories,
                "description": description,
                "ficha_tecnica": ficha_tecnica_url,
                "cotizacion": cotizacion_message
            }
            products.append(product_data)

        print(f"Productos obtenidos de la p√°gina {page}.")
        page += 1

    with open("productos.json", "w", encoding="utf-8") as file:
        json.dump({"products": products}, file, ensure_ascii=False, indent=4)
    
    print("Todos los productos han sido guardados en productos.json")
